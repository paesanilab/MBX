#include "mbnrg_1b_A1B2_deg6_vmbpbe.h"

////////////////////////////////////////////////////////////////////////////////

namespace mbnrg_A1B2_deg6 {

mbnrg_A1B2_deg6_vmbpbe::mbnrg_A1B2_deg6_vmbpbe(const std::string mon1) {
    // =====>> BEGIN SECTION CONSTRUCTOR <<=====
    // =>> PASTE RIGHT BELOW THIS LINE <==

    if (mon1 == "mbpbe") {
        coefficients = std::vector<double>{1.399413526032413e+03,   // 0
                                           -8.188012303406360e+02,  // 1
                                           -1.998469438916813e+03,  // 2
                                           -6.968243736752291e+02,  // 3
                                           1.360304188351023e+03,   // 4
                                           1.113588764914643e+03,   // 5
                                           5.323945919621528e+02,   // 6
                                           -3.388495646142625e+02,  // 7
                                           1.101382039248987e+03,   // 8
                                           1.241259694683234e+03,   // 9
                                           -9.620804288750737e+02,  // 10
                                           -3.048982767761102e+03,  // 11
                                           -1.992307488119520e+03,  // 12
                                           -2.130406067037374e+03,  // 13
                                           2.206288539905275e+03,   // 14
                                           -8.726872681296642e+02,  // 15
                                           7.589893870077108e+02,   // 16
                                           -4.280425999325106e+02,  // 17
                                           3.332674328672110e+02,   // 18
                                           -1.533292705356804e+02,  // 19
                                           1.226097439136981e+03,   // 20
                                           3.204302934302096e+02,   // 21
                                           -8.440321066585686e+02,  // 22
                                           -2.711682706500657e+02,  // 23
                                           2.139212297528176e+03,   // 24
                                           1.165136841125014e+03,   // 25
                                           1.096483059331003e+03,   // 26
                                           -2.059465075973439e+03,  // 27
                                           2.554198614292255e+03,   // 28
                                           -1.373946478118471e+03,  // 29
                                           -1.365043326840889e+03,  // 30
                                           -5.820802024048180e+02,  // 31
                                           5.682544875130778e+02,   // 32
                                           1.936236882886696e+03,   // 33
                                           7.428380757015999e+02,   // 34
                                           -3.732972680368495e+03,  // 35
                                           8.593848431182618e+02,   // 36
                                           -9.341891883526431e+02,  // 37
                                           2.392046802883674e+02,   // 38
                                           1.026082283038101e+03,   // 39
                                           -3.550704608454960e+02,  // 40
                                           1.585861640177254e+03,   // 41
                                           3.158772533759962e+03,   // 42
                                           -1.149451358060151e+02,  // 43
                                           -1.001025645481171e+03,  // 44
                                           -6.582481648846356e+02,  // 45
                                           1.065253860175611e+03,   // 46
                                           2.949421638499998e+02,   // 47
                                           6.675215389235271e+02};  // 48
        m_k_x_intra_A_B_1 = 7.278471535225877e-01;                  // A^(-1))
        m_k_x_intra_B_B_1 = 2.924745286903587e-01;                  // A^(-1))
        m_ri = 7.000000000000000e+00;                               // A
        m_ro = 8.000000000000000e+00;                               // A

    }  // end if mon1 == "mbpbe"

    if (mon1 == "h2o-scan") {
        coefficients = std::vector<double> {
             1.426804941985343e+03, // 0
            -7.783602897995643e+02, // 1
            -2.050644436496629e+03, // 2
            -7.388853450370150e+02, // 3
             1.330388419767801e+03, // 4
             1.115136588172479e+03, // 5
             5.752482417675220e+02, // 6
            -3.648115369567726e+02, // 7
             1.092005018947114e+03, // 8
             1.240795536003614e+03, // 9
            -9.973049787574620e+02, // 10
            -3.089132269152212e+03, // 11
            -2.033245524317272e+03, // 12
            -2.185498753369240e+03, // 13
             2.277370290342215e+03, // 14
            -8.266525492503465e+02, // 15
             7.793125621581648e+02, // 16
            -4.174140269543894e+02, // 17
             3.438806335153478e+02, // 18
            -1.756672195522124e+02, // 19
             1.227060044662657e+03, // 20
             3.492719673476036e+02, // 21
            -8.708832973934027e+02, // 22
            -3.072742605061672e+02, // 23
             2.163483644740685e+03, // 24
             1.201447971581480e+03, // 25
             1.169151540836173e+03, // 26
            -2.118081325908438e+03, // 27
             2.587259254036742e+03, // 28
            -1.376962492410906e+03, // 29
            -1.411628359035745e+03, // 30
            -5.666685472703854e+02, // 31
             5.988167577048414e+02, // 32
             1.978120969422162e+03, // 33
             7.769621578381795e+02, // 34
            -3.827883999585203e+03, // 35
             8.992569373441688e+02, // 36
            -9.566905937735985e+02, // 37
             2.532742441997454e+02, // 38
             9.704955669973256e+02, // 39
            -3.887933862519563e+02, // 40
             1.634801264322228e+03, // 41
             3.221734134126385e+03, // 42
            -8.869604307730961e+01, // 43
            -1.047562662615910e+03, // 44
            -6.734654681982198e+02, // 45
             1.047516833559564e+03, // 46
             2.891134043015458e+02, // 47
             6.853442587585691e+02}; // 48
        m_k_x_intra_A_B_1 =  7.258319718696326e-01; // A^(-1))
        m_k_x_intra_B_B_1 =  2.976533004140174e-01; // A^(-1))
        m_ri =  7.000000000000000e+00; // A
        m_ro =  8.000000000000000e+00; // A

    } // end if mon1 == "h2o-scan"

    if (mon1 == "h2o-dcscan") {
        coefficients = std::vector<double> {
             1.170725994677929e+03, // 0
            -6.231693064731620e+02, // 1
            -1.618283489022346e+03, // 2
            -9.995029921560520e+02, // 3
             1.224879439405316e+03, // 4
             1.168385080670329e+03, // 5
             9.022757853830317e+02, // 6
            -4.629433301061883e+02, // 7
             7.652393504905908e+02, // 8
             8.866624258305898e+02, // 9
            -8.708327189207816e+02, // 10
            -2.871059317815303e+03, // 11
            -1.877195544843577e+03, // 12
            -2.030225034186238e+03, // 13
             2.093511553441515e+03, // 14
            -5.498009458772755e+02, // 15
             5.508900629022986e+02, // 16
            -2.093035690135742e+02, // 17
             1.876285160781394e+02, // 18
            -5.692871426628632e+02, // 19
             1.338437820183813e+03, // 20
             4.489532766545441e+02, // 21
            -8.048580085273911e+02, // 22
            -1.901290262340288e+02, // 23
             1.681233419117896e+03, // 24
             1.097454522155363e+03, // 25
             1.136887351558247e+03, // 26
            -2.107801890377031e+03, // 27
             2.793553676641210e+03, // 28
            -1.003380866947112e+03, // 29
            -1.294132135229811e+03, // 30
            -3.925729678063651e+02, // 31
             3.812389298226580e+02, // 32
             1.641557591821358e+03, // 33
             6.413753982439054e+02, // 34
            -3.170346906319915e+03, // 35
             8.452812186974983e+02, // 36
            -6.937692433263725e+02, // 37
             1.725334609236334e+02, // 38
             5.845032731307907e+02, // 39
            -3.171679559912399e+02, // 40
             1.596215461818886e+03, // 41
             3.410609483259846e+03, // 42
             1.760325143279251e+02, // 43
            -9.455532079264393e+02, // 44
            -5.030706946368323e+02, // 45
             1.098524828379163e+03, // 46
             3.382175903968105e+02, // 47
             6.566847980612276e+02}; // 48
        m_k_x_intra_A_B_1 =  7.558774241984640e-01; // A^(-1))
        m_k_x_intra_B_B_1 =  3.541068839845696e-01; // A^(-1))
        m_ri =  7.000000000000000e+00; // A
        m_ro =  8.000000000000000e+00; // A

    }

    // =====>> END SECTION CONSTRUCTOR <<=====
}

//----------------------------------------------------------------------------//

double mbnrg_A1B2_deg6_vmbpbe::f_switch(const double r, double& g) {
    if (r > m_ro) {
        g = 0.0;
        return 0.0;
    } else if (r > m_ri) {
        const double t1 = M_PI / (m_ro - m_ri);
        const double x = (r - m_ri) * t1;
        g = -std::sin(x) * t1 / 2.0;
        return (1.0 + std::cos(x)) / 2.0;
    } else {
        g = 0.0;
        return 1.0;
    }
}

//----------------------------------------------------------------------------//

std::vector<double> mbnrg_A1B2_deg6_vmbpbe::eval(const double* xyz1, const size_t n) {
    std::vector<double> energies(n, 0.0);
    std::vector<double> energies_sw(n, 0.0);

    std::vector<double> xyz(9);
    double sw = 0.0;
    polynomial my_poly;

    for (size_t j = 0; j < n; j++) {
        const double* mon1 = xyz1 + 9 * j;

        if (false) {
            continue;
        }

        std::copy(mon1, mon1 + 9, xyz.begin() + 0);

        const double* coords_A_1_a = xyz.data() + 0;

        const double* coords_B_1_a = xyz.data() + 3;

        const double* coords_B_2_a = xyz.data() + 6;

        double w12 = -9.721486914088159e-02;  // from MBpol
        double w13 = -9.721486914088159e-02;
        double wcross = 9.859272078406150e-02;

        variable vs[3];

        double xs[3];

        xs[0] = vs[0].v_exp(m_k_x_intra_A_B_1, coords_A_1_a, coords_B_1_a);
        xs[1] = vs[1].v_exp(m_k_x_intra_A_B_1, coords_A_1_a, coords_B_2_a);
        xs[2] = vs[2].v_exp(m_k_x_intra_B_B_1, coords_B_1_a, coords_B_2_a);

        sw = 1.0;

        energies[j] = my_poly.eval(xs, coefficients.data());
        energies_sw[j] = energies[j] * sw;
    }
    return energies_sw;
}

//----------------------------------------------------------------------------//

std::vector<double> mbnrg_A1B2_deg6_vmbpbe::eval(const double* xyz1, double* grad1, const size_t n,
                                                 std::vector<double>* virial) {
    std::vector<double> energies(n, 0.0);
    std::vector<double> energies_sw(n, 0.0);

    std::vector<double> xyz(9);
    double sw = 0.0;
    polynomial my_poly;

    for (size_t j = 0; j < n; j++) {
        const double* mon1 = xyz1 + 9 * j;

        if (false) {
            continue;
        }

        std::vector<double> gradients(9, 0.0);

        std::copy(mon1, mon1 + 9, xyz.begin() + 0);
        const double* coords_A_1_a = xyz.data() + 0;

        const double* coords_B_1_a = xyz.data() + 3;

        const double* coords_B_2_a = xyz.data() + 6;

        double* coords_A_1_a_g = gradients.data() + 0;

        double* coords_B_1_a_g = gradients.data() + 3;

        double* coords_B_2_a_g = gradients.data() + 6;

        double w12 = -9.721486914088159e-02;  // from MBpol
        double w13 = -9.721486914088159e-02;
        double wcross = 9.859272078406150e-02;

        variable vs[3];

        double xs[3];

        double gxs[3];

        xs[0] = vs[0].v_exp(m_k_x_intra_A_B_1, coords_A_1_a, coords_B_1_a);
        xs[1] = vs[1].v_exp(m_k_x_intra_A_B_1, coords_A_1_a, coords_B_2_a);
        xs[2] = vs[2].v_exp(m_k_x_intra_B_B_1, coords_B_1_a, coords_B_2_a);

        sw = 1.0;

        energies[j] = my_poly.eval(xs, coefficients.data(), gxs);
        energies_sw[j] = energies[j] * sw;

        for (size_t i = 0; i < 3; i++) {
            gxs[i] *= sw;
        }

        vs[0].grads(gxs[0], coords_A_1_a_g, coords_B_1_a_g, coords_A_1_a, coords_B_1_a);
        vs[1].grads(gxs[1], coords_A_1_a_g, coords_B_2_a_g, coords_A_1_a, coords_B_2_a);
        vs[2].grads(gxs[2], coords_B_1_a_g, coords_B_2_a_g, coords_B_1_a, coords_B_2_a);

        for (size_t i = 0; i < 3; i++) {
            gradients[0 + i] += 0.0;
        }

        for (size_t i = 0; i < 9; i++) {
            grad1[i + j * 9] += gradients[0 + i];
        }

        if (virial != 0) {
            (*virial)[0] += -coords_A_1_a[0] * coords_A_1_a_g[0] - coords_B_1_a[0] * coords_B_1_a_g[0] -
                            coords_B_2_a[0] * coords_B_2_a_g[0];

            (*virial)[1] += -coords_A_1_a[0] * coords_A_1_a_g[1] - coords_B_1_a[0] * coords_B_1_a_g[1] -
                            coords_B_2_a[0] * coords_B_2_a_g[1];

            (*virial)[2] += -coords_A_1_a[0] * coords_A_1_a_g[2] - coords_B_1_a[0] * coords_B_1_a_g[2] -
                            coords_B_2_a[0] * coords_B_2_a_g[2];

            (*virial)[4] += -coords_A_1_a[1] * coords_A_1_a_g[1] - coords_B_1_a[1] * coords_B_1_a_g[1] -
                            coords_B_2_a[1] * coords_B_2_a_g[1];

            (*virial)[5] += -coords_A_1_a[1] * coords_A_1_a_g[2] - coords_B_1_a[1] * coords_B_1_a_g[2] -
                            coords_B_2_a[1] * coords_B_2_a_g[2];

            (*virial)[8] += -coords_A_1_a[2] * coords_A_1_a_g[2] - coords_B_1_a[2] * coords_B_1_a_g[2] -
                            coords_B_2_a[2] * coords_B_2_a_g[2];

            (*virial)[3] = (*virial)[1];
            (*virial)[6] = (*virial)[2];
            (*virial)[7] = (*virial)[5];
        }
    }
    return energies_sw;
}

//----------------------------------------------------------------------------//
}  // namespace mbnrg_A1B2_deg6
